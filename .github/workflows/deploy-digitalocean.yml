name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Deploy to DigitalOcean via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USER }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: ${{ secrets.DIGITALOCEAN_SSH_PORT }}
          script_stop: true
          script: |
            cd /var/www/html
            git pull origin main
            
            # Set proper file permissions
            # Use error suppression to ensure critical commands always execute
            find . -type d -exec chmod 755 {} \; 2>/dev/null || true
            find . -type f -exec chmod 644 {} \; 2>/dev/null || true
            chmod -R 755 uploads/ 2>/dev/null || true
            # Critical: Always secure .env file permissions
            chmod 600 .env 2>/dev/null || true
            
            # Restart Apache (if using Apache)
            sudo systemctl reload apache2 || true
            
            # Restart PHP-FPM (if using Nginx)
            # sudo systemctl restart php8.0-fpm || true
            
            echo "Deployment completed successfully!"

